CREATE DATABASE ECOMMERCE_REPORT;
USE ECOMMERCE_REPORT;

-- Import Datasets Tables : CUSTOMERS, PRODUCTS, ORDERS, ORDER_ITEMS.

SELECT * FROM CUSTOMERS LIMIT 5;

/*
    Customer_id |   Customer_Name | Gender  | City      | Signup_Date

    1           |	Customer_1    | Male	| Hyderabad | 09-06-2021
    2           |	Customer_2    |	Female	| Kolkata   | 20-06-2021
    3           |	Customer_3    |	Male	| Mumbai    | 09-09-2021
    4           |	Customer_4    |	Male	| Mumbai    | 13-06-2023
    5           |	Customer_5    |	Male	| Mumbai    | 27-09-2023

*/

SELECT * FROM PRODUCTS LIMIT 5;

/*
    Product_id | Product_name | Categoey    | Price

    1	       | Product_1	  | Fashion	    | 26062
    2	       | Product_2	  | Grocery	    | 39542
    3	       | Product_3	  | Electronics	| 99358
    4	       | Product_4	  | Toys	    | 39162
    5	       | Product_5	  | Toys	    | 80917

*/

SELECT * FROM ORDERS LIMIT 5;

/*

    Order_id | Customer_id | Order_date | Payment_method | Order_status

    10001	 | 937	       | 29-04-2022	| Credit Card	 | Delivered
    10002	 | 902	       | 29-01-2023	| Wallet	     | Returned
    10003	 | 25	       | 08-03-2023	| Debit Card	 | Cancelled
    10004	 | 653	       | 14-12-2022	| Debit Card	 | Delivered
    10005	 | 117	       | 14-09-2023	| Wallet	     | Delivered

*/

SELECT * FROM ORDER_ITEMS LIMIT 5;

/*

    Item_id | Order_id | Product_id | Quantity

    1	    | 10535	   | 145	    | 3
    2	    | 10210	   | 127	    | 3
    3	    | 12094	   | 226	    | 1
    4	    | 11564	   | 427	    | 1
    5	    | 10026	   | 71	        | 3

*/

#-DATA CLEANING:

-- 1. ROW COUNT CHECK

SELECT COUNT(*) FROM CUSTOMERS;
SELECT COUNT(*) FROM PRODUCTS;
SELECT COUNT(*) FROM ORDERS;
SELECT COUNT(*) FROM ORDER_ITEMS;


-- 2. NULL VALUE CHECK

SELECT * FROM CUSTOMERS
WHERE CUSTOMER_ID IS NULL
   OR SIGNUP_DATE IS NULL;

SELECT * FROM ORDERS
WHERE ORDER_ID IS NULL
   OR CUSTOMER_ID IS NULL
   OR ORDER_DATE IS NULL;

SELECT * FROM ORDER_ITEMS
WHERE ORDER_ID IS NULL
   OR PRODUCT_ID IS NULL
   OR QUANTITY IS NULL;
   

-- 3. DUPLICATE RECORD CHECK

SELECT CUSTOMER_ID, COUNT(*)
FROM CUSTOMERS
GROUP BY CUSTOMER_ID
HAVING COUNT(*) > 1;

SELECT ORDER_ID, COUNT(*)
FROM ORDERS
GROUP BY ORDER_ID
HAVING COUNT(*) > 1;


-- 4. REMOVE DUPLICATE CUSTOMERS

DELETE C1
FROM CUSTOMERS C1
JOIN CUSTOMERS C2
ON C1.CUSTOMER_ID = C2.CUSTOMER_ID
AND C1.CUSTOMER_ID > C2.CUSTOMER_ID;


-- 5. ORPHAN RECORD CHECK

SELECT O.*
FROM ORDERS O
LEFT JOIN CUSTOMERS C
ON O.CUSTOMER_ID = C.CUSTOMER_ID
WHERE C.CUSTOMER_ID IS NULL;

SELECT OI.*
FROM ORDER_ITEMS OI
LEFT JOIN ORDERS O
ON OI.ORDER_ID = O.ORDER_ID
WHERE O.ORDER_ID IS NULL;


-- 6. DATE VALIDATION

SELECT *
FROM ORDERS
WHERE ORDER_DATE < '2000-01-01'
   OR ORDER_DATE > CURDATE();
   

-- 7. FIX DATE FORMAT (IF STORED AS STRING)

UPDATE ORDERS
SET ORDER_DATE = STR_TO_DATE(ORDER_DATE, '%Y-%M-%D');


-- 8. INVALID QUANTITY OR PRICE CHECK

SELECT *
FROM ORDER_ITEMS OI
JOIN PRODUCTS P
   ON P.PRODUCT_ID = OI.PRODUCT_ID
WHERE QUANTITY <= 0
   OR PRICE <= 0;
   

-- 9. ADD BASIC DATA CONSTRAINTS

ALTER TABLE ORDER_ITEMS
MODIFY QUANTITY INT CHECK (QUANTITY > 0);

ALTER TABLE PRODUCTS
MODIFY PRICE DECIMAL(10,2) CHECK (PRICE > 0);


#-ðŸ§± BASIC BUSINESS INSIGHTS (JOIN + GROUP BY)

#1. List all customers along with their total number of orders.
---#(Include customers who have never placed an order.)

SELECT 
   C.CUSTOMER_ID,
   C.CUSTOMER_NAME,
   COUNT(O.ORDER_ID) AS TOTAL_ORDERS
FROM CUSTOMERS C
LEFT JOIN ORDERS O
   ON C.CUSTOMER_ID = O.CUSTOMER_ID
GROUP BY 
   C.CUSTOMER_ID,
   C.CUSTOMER_NAME
ORDER BY
   TOTAL_ORDERS DESC;
   
   
#2.	Find total revenue generated by each product.

SELECT 
   P.PRODUCT_ID,
   P.PRODUCT_NAME,
   SUM(P.PRICE * OI.QUANTITY) AS TOTAL_REVENUE
FROM PRODUCTS P
JOIN ORDER_ITEMS OI
   ON OI.PRODUCT_ID = P.PRODUCT_ID
GROUP BY 
   P.PRODUCT_ID,
   P.PRODUCT_NAME
ORDER BY 
   TOTAL_REVENUE DESC;
   

#3.	Identify the top 5 best-selling products by total quantity sold.

SELECT
   P.PRODUCT_ID,
   P.PRODUCT_NAME,
   SUM(OI.QUANTITY) AS TOTAL_QUANTITY_SOLD
FROM PRODUCTS P
JOIN ORDER_ITEMS OI
   ON OI.PRODUCT_ID = P.PRODUCT_ID
GROUP BY 
   P.PRODUCT_ID,
   P.PRODUCT_NAME
ORDER BY
   TOTAL_QUANTITY_SOLD DESC
LIMIT 5;


#4.	Show total revenue generated by each city.

SELECT 
   C.CITY,
   SUM(P.PRICE * OI.QUANTITY) AS TOTAL_REVENUE
FROM CUSTOMERS C
JOIN ORDERS O
   ON C.CUSTOMER_ID = O.CUSTOMER_ID
JOIN ORDER_ITEMS OI
   ON OI.ORDER_ID = O.ORDER_ID
JOIN PRODUCTS P
   ON P.PRODUCT_ID = OI.PRODUCT_ID
GROUP BY 
   C.CITY
ORDER BY
   TOTAL_REVENUE DESC;
   
   
#5.	Find customers who have placed more than 5 orders.

SELECT 
   C.CUSTOMER_ID,
   C.CUSTOMER_NAME,
   COUNT(O.ORDER_ID) AS TOTAL_ORDERS
FROM CUSTOMERS C
JOIN ORDERS O
   ON O.CUSTOMER_ID = C.CUSTOMER_ID
GROUP BY 
   C.CUSTOMER_ID,
   C.CUSTOMER_NAME
HAVING 
   COUNT(O.ORDER_ID) > 5
ORDER BY 
   TOTAL_ORDERS DESC;
   
   
#6 Find the catogory wise revenue.

SELECT 
    P.CATEGORY,
    CONCAT(ROUND(SUM(OI.QUANTITY * P.PRICE)/10000000,2),' Cr') AS TOTAL_REVENUE 
FROM PRODUCTS P
JOIN ORDER_ITEMS OI
    ON OI.PRODUCT_ID = P.PRODUCT_ID
GROUP BY
    P.CATEGORY
ORDER BY
    TOTAL_REVENUE DESC;


#ðŸ“† DATE & TIME ANALYSIS (DATE FUNCTIONS).

#7.	Calculate total revenue month-by-month.


SELECT
    DATE_FORMAT(O.ORDER_DATE, '%Y-%m') AS ORDER_MONTH,
    CONCAT(ROUND(SUM(OI.QUANTITY * P.PRICE) / 100000, 2),' Lakhs') AS TOTAL_REVENUE
FROM ORDERS O
JOIN ORDER_ITEMS OI
    ON O.ORDER_ID = OI.ORDER_ID
JOIN PRODUCTS P
    ON OI.PRODUCT_ID = P.PRODUCT_ID
GROUP BY 
    ORDER_MONTH
ORDER BY
	ORDER_MONTH DESC;
    
    
#8.	Find the number of orders placed each day in the last 30 days.

SELECT 
    DATE(O.ORDER_DATE) AS ORDER_DATE,
    COUNT(O.ORDER_ID) AS TOTAL_ORDERS
FROM ORDERS O 
WHERE O.ORDER_DATE >=(
	SELECT MAX(ORDER_DATE) - INTERVAL 30 DAY
    FROM ORDERS
    )
GROUP BY
    ORDER_DATE
ORDER BY
    ORDER_DATE; 
    
    
#9.	Calculate average order value (AOV) per month.

SELECT 
    DATE_FORMAT(O.ORDER_DATE, '%Y-%m') AS ORDER_DATE,
    CONCAT(ROUND(SUM(OI.QUANTITY * P.PRICE) /COUNT(DISTINCT O.ORDER_ID)/100000,2),' L') AS AOV 
FROM ORDERS O
JOIN ORDER_ITEMS OI
    ON O.ORDER_ID = OI.ORDER_ID
JOIN PRODUCTS P
    ON P.PRODUCT_ID = OI.PRODUCT_ID
GROUP BY 
    ORDER_DATE
ORDER BY 
    ORDER_DATE DESC;
    
    
#10. Find products that have not been sold in the last 6 months.

SELECT 
   P.PRODUCT_ID,
   P.PRODUCT_NAME
FROM PRODUCTS P
LEFT JOIN ORDER_ITEMS OI
   ON P.PRODUCT_ID = OI.PRODUCT_ID
LEFT JOIN ORDERS O
   ON OI.ORDER_ID = O.ORDER_ID
   AND O.ORDER_DATE >= CURDATE() - INTERVAL 6 MONTH
WHERE ORDER_DATE IS NULL;


#ðŸ§® AGGREGATION + CASE STATEMENTS.

#11. Show total revenue split by payment method (COD/Credit card/UPI/Wallet/Debit card).


SELECT
    O.PAYMENT_METHOD,
    CONCAT(ROUND(SUM(OI.QUANTITY * P.PRICE)/10000000,2),'Cr') AS TOTAL_REVENUE
FROM ORDERS O
JOIN ORDER_ITEMS OI
    ON O.ORDER_ID = OI.ORDER_ID
JOIN PRODUCTS P
    ON P.PRODUCT_ID = OI.PRODUCT_ID
GROUP BY
    O.PAYMENT_METHOD
ORDER BY
    TOTAL_REVENUE DESC;
    
    
#12. Identify products as â€˜High Demandâ€™ or â€˜Low Demandâ€™ based on quantity sold.

SELECT 
    P.PRODUCT_ID,
    P.PRODUCT_NAME,
    P.CATEGORY,
    SUM(OI.QUANTITY) AS TOTAL_QUANTITY_SOLD,
    CASE
        WHEN SUM(OI.QUANTITY) >= 50 THEN 'HIGH DEMAND'
        ELSE 'LOW DEMAND'
	END AS DEMAND_STATUS
FROM PRODUCTS P
JOIN ORDER_ITEMS OI
    ON P.PRODUCT_ID = OI.PRODUCT_ID
GROUP BY
    P.PRODUCT_ID,
    P.PRODUCT_NAME,
    P.CATEGORY
ORDER BY
    DEMAND_STATUS;
    
    
#ðŸ” SUBQUERIES (INTERMEDIATE LEVEL):

#13. Find customers whose total spending is above the average customer spend.

SELECT 
    C.CUSTOMER_ID,
    C.CUSTOMER_NAME,
    SUM(OI.QUANTITY * P.PRICE) AS TOTAL_SPEND
FROM CUSTOMERS C
JOIN ORDERS O
    ON C.CUSTOMER_ID = O.CUSTOMER_ID
JOIN ORDER_ITEMS OI
    ON O.ORDER_ID = OI.ORDER_ID
JOIN PRODUCTS P
    ON OI.PRODUCT_ID = P.PRODUCT_ID
GROUP BY 
	C.CUSTOMER_ID,
    C.CUSTOMER_NAME
HAVING 
    SUM(OI.QUANTITY * P.PRICE) >
    (
        SELECT 
            AVG(CUSTOMER_TOTAL)
        FROM (
            SELECT
                SUM(OI2.QUANTITY * P2.PRICE) AS CUSTOMER_TOTAL
            FROM ORDER_ITEMS OI2
			JOIN PRODUCTS P2
                ON OI2.PRODUCT_ID = P2.PRODUCT_ID
			JOIN ORDERS O2
                ON O2.ORDER_ID = OI2.ORDER_ID
			JOIN CUSTOMERS C2
                ON O2.CUSTOMER_ID = C2.CUSTOMER_ID
			GROUP BY 
                O2.CUSTOMER_ID
        ) T
    )
ORDER BY
    TOTAL_SPEND DESC;
    
    
#14. Find products priced higher than the average product price.

SELECT
    PRODUCT_ID,
    PRODUCT_NAME,
    PRICE
FROM PRODUCTS
WHERE PRICE >
      (
          SELECT AVG(PRICE)
          FROM PRODUCTS
      )
ORDER BY 
    PRICE DESC;
    
    
#15. Identify orders whose value is higher than the average order value.

SELECT 
    O.ORDER_ID,
    SUM(OI.QUANTITY * P.PRICE) AS VALUE
FROM ORDERS O
JOIN ORDER_ITEMS OI
    ON O.ORDER_ID = OI.ORDER_ID
JOIN PRODUCTS P
    ON OI.PRODUCT_ID = P.PRODUCT_ID
GROUP BY
    O.ORDER_ID
HAVING
    VALUE >
      (
       SELECT AVG(ORDER_TOTAL)
       FROM (
             SELECT 
                SUM(OI2.QUANTITY * P2.PRICE) AS ORDER_TOTAL
			 FROM ORDER_ITEMS OI2
             JOIN PRODUCTS P2
				ON OI2.PRODUCT_ID = P2.PRODUCT_ID
			 GROUP BY 
                OI2.ORDER_ID
			) T
	   )
ORDER BY 
	  VALUE DESC;
      
      
#16. Find customers who placed orders in both the current and previous month
          
SELECT DISTINCT CUSTOMER_ID
FROM ORDERS
WHERE DATE_FORMAT(ORDER_DATE, '%Y-%m') =
(
        SELECT DATE_FORMAT(MAX(ORDER_DATE), '%Y-%m')
        FROM ORDERS
)
AND CUSTOMER_ID IN (
        SELECT CUSTOMER_ID
        FROM ORDERS
        WHERE DATE_FORMAT(ORDER_DATE, '%Y-%m') = (
                SELECT DATE_FORMAT(
                           DATE_SUB(MAX(ORDER_DATE), INTERVAL 1 MONTH),
                           '%Y-%m'
                                  )
                FROM ORDERS
        )
)
ORDER BY CUSTOMER_ID;


#ðŸ§  WINDOW FUNCTIONS (ADVANCED ANALYTICS):

#17. Rank products based on total revenue generated.

SELECT   
    P.PRODUCT_ID,
    P.PRODUCT_NAME,
    CONCAT(ROUND(SUM(OI.QUANTITY * P.PRICE)/100000,2),' L') AS TOTAL_REVENUE,
    RANK() OVER(ORDER BY SUM(OI.QUANTITY * P.PRICE) DESC) AS REVENUE_RANK
FROM PRODUCTS P
JOIN ORDER_ITEMS OI
    ON P.PRODUCT_ID = OI.PRODUCT_ID
GROUP BY 
    P.PRODUCT_ID,
    P.PRODUCT_NAME;
    
    
#18. Calculate running total revenue month-by-month.

SELECT 
   SALES_MONTH,
   MONTHLY_REVENUE,
   CONCAT(SUM(MONTHLY_REVENUE) OVER(
       ORDER BY SALES_MONTH
       ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
   ),' Cr') AS RUNNING_TOTAL_REVENUE
FROM (
        SELECT 
           DATE_FORMAT(O.ORDER_DATE,'%Y-%m') AS SALES_MONTH,
           CONCAT(ROUND(SUM(OI.QUANTITY * P.PRICE)/10000000,2),' Cr') AS MONTHLY_REVENUE
		FROM ORDERS O
		JOIN ORDER_ITEMS OI
           ON O.ORDER_ID = OI.ORDER_ID
		JOIN PRODUCTS P
           ON OI.PRODUCT_ID = P.PRODUCT_ID
		GROUP BY
           SALES_MONTH
	 ) M
ORDER BY 
   SALES_MONTH;
   

#19. Calculate month-over-month revenue growth percentage.

SELECT 
   SALES_MONTH,
   MONTHLY_REVENUE,
   LAG(MONTHLY_REVENUE) OVER (ORDER BY SALES_MONTH) AS PREVIOUS_MONTH_REVENUE,
   CONCAT(ROUND(
        ( 
         MONTHLY_REVENUE - LAG(MONTHLY_REVENUE) OVER (ORDER BY SALES_MONTH)
		)/ LAG(MONTHLY_REVENUE) OVER (ORDER BY SALES_MONTH) *100,2
        ),'%') AS MOM_GROWTH_PERCENT
FROM (
      SELECT 
         DATE_FORMAT(O.ORDER_DATE,'%Y-%m') AS SALES_MONTH,
         CONCAT(ROUND(SUM(OI.QUANTITY * P.PRICE)/10000000,2),' Cr') AS MONTHLY_REVENUE
	  FROM ORDERS O
      JOIN ORDER_ITEMS OI
         ON O.ORDER_ID = OI.ORDER_ID
	  JOIN PRODUCTS P
         ON OI.PRODUCT_ID = P.PRODUCT_ID
	  GROUP BY
	     SALES_MONTH
	) M
ORDER BY
     SALES_MONTH;


#ðŸ§© COMMON TABLE EXPRESSIONS (CTEs):

#20. Identify top 3 products per category using a CTE and window function.  

WITH PRODUCT_REVENUE_CTE AS (
    SELECT
        P.CATEGORY,
        P.PRODUCT_ID,
        P.PRODUCT_NAME,
        SUM(OI.QUANTITY * P.PRICE) AS TOTAL_REVENUE
    FROM PRODUCTS P
    JOIN ORDER_ITEMS OI
        ON P.PRODUCT_ID = OI.PRODUCT_ID
    GROUP BY
        P.CATEGORY,
        P.PRODUCT_ID,
        P.PRODUCT_NAME
)
SELECT 
    CATEGORY,
    PRODUCT_ID,
    PRODUCT_NAME,
    TOTAL_REVENUE
FROM (
        SELECT
            CATEGORY,
            PRODUCT_ID,
            PRODUCT_NAME,
            TOTAL_REVENUE,
            DENSE_RANK() OVER (
                PARTITION BY CATEGORY
                ORDER BY TOTAL_REVENUE DESC
            ) AS REVENUE_RANK
        FROM PRODUCT_REVENUE_CTE
     ) R
WHERE REVENUE_RANK <= 3
ORDER BY CATEGORY, REVENUE_RANK;


#21. FIND THE TOP-SELLING PRODUCT (BY REVENUE) FOR EACH MONTH.

WITH MONTHLY_PRODUCT_REVENUE AS (
    SELECT
        DATE_FORMAT(O.ORDER_DATE, '%Y-%m') AS SALES_MONTH,
        P.PRODUCT_ID,
        P.PRODUCT_NAME,
        SUM(OI.QUANTITY * P.PRICE) AS MONTHLY_REVENUE
    FROM ORDERS O
    JOIN ORDER_ITEMS OI
        ON O.ORDER_ID = OI.ORDER_ID
    JOIN PRODUCTS P
        ON OI.PRODUCT_ID = P.PRODUCT_ID
    GROUP BY
        DATE_FORMAT(O.ORDER_DATE, '%Y-%m'),
        P.PRODUCT_ID,
        P.PRODUCT_NAME
),

RANKED_PRODUCTS AS (
    SELECT
        SALES_MONTH,
        PRODUCT_ID,
        PRODUCT_NAME,
        MONTHLY_REVENUE,
        RANK() OVER (
            PARTITION BY SALES_MONTH
            ORDER BY MONTHLY_REVENUE DESC
        ) AS REVENUE_RANK
    FROM MONTHLY_PRODUCT_REVENUE
)

SELECT
    SALES_MONTH,
    PRODUCT_ID,
    PRODUCT_NAME,
    MONTHLY_REVENUE
FROM RANKED_PRODUCTS
WHERE REVENUE_RANK =1
ORDER BY SALES_MONTH;


#22. Find customers who placed more than one order in the same month.

SELECT
    CUSTOMER_ID,
    DATE_FORMAT(ORDER_DATE, '%Y-%m') AS ORDER_MONTH,
    COUNT(ORDER_ID) AS TOTAL_ORDERS
FROM ORDERS
GROUP BY
    CUSTOMER_ID,
    DATE_FORMAT(ORDER_DATE, '%Y-%m')
HAVING COUNT(ORDER_ID) > 1
ORDER BY CUSTOMER_ID, ORDER_MONTH;


#(Uses JOIN + CTE + GROUP BY + WINDOW + DATE FUNCTIONS)
# For each month, find:
---#--- Total orders.
---#--- Total revenue.
---#--- Top product.
---#--- Top city.


WITH MONTHLY_BASE AS (
     SELECT 
        DATE_FORMAT(O.ORDER_DATE,'%Y-%m') AS SALES_MONTH,
        O.ORDER_ID,
        C.CITY,
        P.PRODUCT_ID,
        P.PRODUCT_NAME,
        OI.QUANTITY * P.PRICE AS REVENUE
	 FROM ORDERS O
     JOIN CUSTOMERS C
        ON O.CUSTOMER_ID = C.CUSTOMER_ID
     JOIN ORDER_ITEMS OI
        ON O.ORDER_ID = OI.ORDER_ID
     JOIN PRODUCTS P
        ON OI.PRODUCT_ID = P.PRODUCT_ID
),

MONTHLY_SUMMARY AS (
     SELECT
        SALES_MONTH,
        COUNT(DISTINCT ORDER_ID) AS TOTAL_ORDERS,
        SUM(REVENUE) AS TOTAL_REVENUE
	 FROM MONTHLY_BASE
     GROUP BY 
        SALES_MONTH
),

PRODUCT_RANKING AS (
     SELECT 
        SALES_MONTH,
        PRODUCT_ID,
        PRODUCT_NAME,
        SUM(REVENUE) AS PRODUCT_REVENUE,
        RANK() OVER(
            PARTITION BY SALES_MONTH
			ORDER BY SUM(REVENUE) DESC
		) AS PRODUCT_RANK
	 FROM MONTHLY_BASE
     GROUP BY
         SALES_MONTH,
         PRODUCT_ID,
         PRODUCT_NAME
),

CITY_RANKING AS (
     SELECT
         SALES_MONTH,
         CITY,
         SUM(REVENUE) AS CITY_REVENUE,
         RANK() OVER(
			 PARTITION BY SALES_MONTH
             ORDER BY SUM(REVENUE) DESC
		 ) AS CITY_RANK
	 FROM MONTHLY_BASE
     GROUP BY
         SALES_MONTH,
         CITY
)

SELECT 
	MS.SALES_MONTH,
    MS.TOTAL_ORDERS,
    MS.TOTAL_REVENUE,
    PR.PRODUCT_NAME AS TOP_PRODUCT,
    CR.CITY AS TOP_CITY
FROM MONTHLY_SUMMARY MS
LEFT JOIN PRODUCT_RANKING PR
    ON MS.SALES_MONTH = PR.SALES_MONTH
   AND PR.PRODUCT_RANK = 1
LEFT JOIN CITY_RANKING CR
    ON MS.SALES_MONTH = CR.SALES_MONTH
   AND CR.CITY_RANK = 1
ORDER BY MS.SALES_MONTH;
        
        













